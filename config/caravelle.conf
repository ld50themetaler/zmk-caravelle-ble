# --- 1. 基本設定 ---
CONFIG_ZMK_BLE=y
CONFIG_ZMK_SPLIT=y
CONFIG_GPIO=y
# BLE識別名と再広告安定化
CONFIG_BT_DEVICE_NAME="Caravelle"
CONFIG_BT_DEVICE_NAME_MAX=31

CONFIG_BT_RPA_TIMEOUT=900
# Bluetooth privacy default: peripheral can enable, central requires it disabled to support identity-based scanning
CONFIG_BT_PRIVACY=n

# 0番ピン解放（最重要）
CONFIG_GPIO_AS_PINRESET=n

# --- 2. クロック設定 (RCオシレータを最も安定させる設定) ---
CONFIG_CLOCK_CONTROL_NRF_K32SRC_RC=y
CONFIG_CLOCK_CONTROL_NRF_K32SRC_XTAL=n
CONFIG_CLOCK_CONTROL_NRF_K32SRC_500PPM=y
# RC校正を有効化してタイミングドリフトを防止
CONFIG_CLOCK_CONTROL_NRF_K32SRC_RC_CALIBRATION=y

# --- 3. Bluetoothスタックの初期化失敗を防ぐ ---
CONFIG_BT_RX_STACK_SIZE=2048
CONFIG_MAIN_STACK_SIZE=2048
CONFIG_BT_CTLR_RX_BUFFERS=10
# 送信パワーを上げて接続安定性を向上
CONFIG_BT_CTLR_TX_PWR_PLUS_4=y

# --- 4. タイミング制約の緩和 ---
# 接続間隔を適度に調整し、CPUの負荷を最小限にします
# スプリットモード無効なので PERIPHERAL 設定は不要
# CONFIG_BT_PERIPHERAL_PREF_MIN_INT=24
# CONFIG_BT_PERIPHERAL_PREF_MAX_INT=40
# CONFIG_BT_PERIPHERAL_PREF_LATENCY=2
# CONFIG_BT_PERIPHERAL_PREF_TIMEOUT=400

# --- 5. ログ無効化 (RAM節約のため) ---
CONFIG_LOG=n

# Increase important thread stacks to reduce chance of stack overflow at runtime
# Host-level RX stack (used by host threads)
# Reduce stacks slightly to fit constrained left central device (peripheral has headroom)
CONFIG_BT_RX_STACK_SIZE=2048
CONFIG_MAIN_STACK_SIZE=2048
# Controller-level RX stack sizes are increased in the controller Kconfig defaults
# (BT_CTLR_RX_PRIO_STACK_SIZE, BT_CTLR_RX_STACK_SIZE) to avoid BT RX thread overflow


# --- 6. その他不要な機能を徹底排除 ---
CONFIG_ZMK_SLEEP=y
CONFIG_ZMK_IDLE_TIMEOUT=30000
CONFIG_ZMK_BATTERY_REPORTING=y
CONFIG_SETTINGS=y
# Use the NVS settings backend so Bluetooth bond data is persisted to flash
CONFIG_NVS=y
CONFIG_SETTINGS_NVS=y
# Configure NVS backend (sector count must be > 0 for nvs to be usable)
CONFIG_SETTINGS_NVS_SECTOR_COUNT=4
# CONFIG_SETTINGS_NVS_NAME_CACHE=y
# Allow runtime settings processing
CONFIG_SETTINGS_RUNTIME=y
# Allow the Bluetooth subsystem to use the settings backend for bonds/keys
CONFIG_BT_SETTINGS=y
# スタック診断を無効化してRAMを節約

# Ensure Nordic SOC flash driver is enabled so flash map/NVS can be used
# Note: enabling SOC flash drivers and flash map may be platform-specific.
# If needed, enable via menuconfig to satisfy dependencies.
CONFIG_SOC_FLASH_NRF=y
# Enable FLASH_MAP already requested via CONFIG_FLASH_MAP=y above


# Ensure NVS-backed settings are usable: need flash map + nvs enabled
# CONFIG_USE_DT_CODE_PARTITION=y
# CONFIG_MPU_ALLOW_FLASH_WRITE=y
CONFIG_NVS=y
# Explicitly enable FLASH so NVS can be selected
CONFIG_FLASH=y
CONFIG_FLASH_PAGE_LAYOUT=y
# Ensure NVS-backed settings are usable
CONFIG_SETTINGS_NVS=y
CONFIG_FLASH_MAP=y